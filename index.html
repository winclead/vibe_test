<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ í• ë¦¬ê°ˆë¦¬ (Web Halli Galli)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #setup-screen {
            position: absolute;
            z-index: 10;
            background: rgba(44, 62, 80, 0.95);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 { margin-bottom: 10px; }

        .game-board {
            display: flex;
            justify-content: space-between;
            width: 80%;
            max-width: 800px;
            flex-wrap: wrap; /* ë‹¤ìˆ˜ í”Œë ˆì´ì–´ ë°°ì¹˜ë¥¼ ìœ„í•´ */
            background-color: #27ae60; /* í…Œì´ë¸” ìƒ‰ìƒ */
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .player-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 45%; /* 4ëª…ì¼ ë•Œ 2ì—´ë¡œ ë°°ì¹˜ */
            margin-bottom: 10px;
        }

        .card-slot {
            width: 120px;
            height: 170px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .card {
            width: 120px;
            height: 170px;
            background-color: white;
            border-radius: 10px;
            color: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: absolute;
            top: 0;
            left: 0;
        }

        .card.back {
            background-color: #e74c3c;
            background-image: repeating-linear-gradient(45deg, #c0392b 25%, transparent 25%, transparent 75%, #c0392b 75%, #c0392b), repeating-linear-gradient(45deg, #c0392b 25%, #e74c3c 25%, #e74c3c 75%, #c0392b 75%, #c0392b);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }

        .bell-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }

        #bell {
            width: 80px;
            height: 80px;
            background-color: #f1c40f;
            border-radius: 50%;
            border: 5px solid #f39c12;
            box-shadow: 0 5px 0 #d35400;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            transition: all 0.1s;
        }

        #bell:active, .bell-ring {
            transform: scale(0.95) !important;
            box-shadow: 0 2px 0 #d35400 !important;
        }

        .controls {
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
        }

        .status {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            height: 30px;
        }

        /* ì¹´ë“œ ë‚´ë¶€ ê³¼ì¼ ë°°ì¹˜ ìŠ¤íƒ€ì¼ */
        .card-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .fruit-icon { 
            font-size: 2rem; 
            margin: 2px;
        }
        
        /* ì„¤ì • í™”ë©´ ìŠ¤íƒ€ì¼ */
        .setup-btn {
            padding: 10px 20px;
            font-size: 1.2rem;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        select {
            padding: 5px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <!-- ì„¤ì • í™”ë©´ -->
    <div id="setup-screen">
        <h1>í• ë¦¬ê°ˆë¦¬ ì„¤ì •</h1>
        <div>
            <label for="player-count" style="font-size: 1.5rem;">ì°¸ê°€ ì¸ì›: </label>
            <select id="player-count">
                <option value="2">2ëª…</option>
                <option value="3">3ëª…</option>
                <option value="4">4ëª…</option>
            </select>
        </div>
        <div style="margin-top: 20px; text-align: left; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;">
            <h3>í‚¤ ì¡°ì‘ ì„¤ëª…</h3>
            <p>Player 1: ë’¤ì§‘ê¸°(Q), ì¢…(A)</p>
            <p>Player 2: ë’¤ì§‘ê¸°(P), ì¢…(L)</p>
            <p>Player 3: ë’¤ì§‘ê¸°(Z), ì¢…(X)</p>
            <p>Player 4: ë’¤ì§‘ê¸°(M), ì¢…(K)</p>
        </div>
        <button class="setup-btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    </div>

    <h1>ì›¹ í• ë¦¬ê°ˆë¦¬ ğŸ“ğŸŒğŸˆğŸ‘</h1>

    <div class="status" id="status-msg">ì¤€ë¹„ ì¤‘...</div>

    <div class="game-board" id="game-board" style="display: none;">
        <!-- Bell -->
        <div class="bell-area">
            <div id="bell">ğŸ””</div>
        </div>
        
        <!-- í”Œë ˆì´ì–´ ì˜ì—­ì€ JSë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <script>
        const fruits = ['ğŸ“', 'ğŸŒ', 'ğŸˆ', 'ğŸ‘'];
        const counts = [1, 2, 3, 4, 5];
        
        let players = []; // { id, deck: [], openCard: null, keys: {flip, bell} }
        let turn = 0; // index of current player
        let gameActive = false;
        let playerCount = 2;

        const keyConfigs = [
            { flip: 'q', bell: 'a', name: 'Player 1' },
            { flip: 'p', bell: 'l', name: 'Player 2' },
            { flip: 'z', bell: 'x', name: 'Player 3' },
            { flip: 'm', bell: 'k', name: 'Player 4' }
        ];

        function startGame() {
            playerCount = parseInt(document.getElementById('player-count').value);
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-board').style.display = 'flex';
            initGame(playerCount);
        }

        // ê²Œì„ ì´ˆê¸°í™”
        function initGame(numPlayers) {
            gameActive = true;
            turn = 0;
            players = [];

            // í”Œë ˆì´ì–´ ë°ì´í„° ì´ˆê¸°í™”
            for(let i=0; i<numPlayers; i++) {
                players.push({
                    id: i + 1,
                    deck: [],
                    openCard: null,
                    config: keyConfigs[i]
                });
            }

            // UI ìƒì„±
            createPlayerUI();

            let fullDeck = [];
            // ë± ìƒì„± (ê° ê³¼ì¼ë³„ë¡œ 1~5ê°œì§œë¦¬ ì¹´ë“œë¥¼ ì ë‹¹íˆ ì„ì–´ì„œ ìƒì„±)
            for (let f of fruits) {
                for (let c of counts) {
                    // ì¸ì›ìˆ˜ì— ë”°ë¼ ì¹´ë“œ ì¥ìˆ˜ ì¡°ì ˆ (ê¸°ë³¸ 3ì„¸íŠ¸)
                    // 4ëª…ì´ë©´ ì¹´ë“œê°€ ê¸ˆë°© ë™ë‚˜ë¯€ë¡œ 4ì„¸íŠ¸ë¡œ ëŠ˜ë¦¼
                    let sets = numPlayers >= 4 ? 4 : 3;
                    for(let i=0; i<sets; i++) fullDeck.push({ fruit: f, count: c });
                }
            }
            
            // ì…”í”Œ
            fullDeck.sort(() => Math.random() - 0.5);

            // ë¶„ë°°
            const cardsPerPlayer = Math.floor(fullDeck.length / numPlayers);
            for(let i=0; i<numPlayers; i++) {
                players[i].deck = fullDeck.slice(i * cardsPerPlayer, (i + 1) * cardsPerPlayer);
            }

            document.getElementById('status-msg').innerText = `ê²Œì„ ì‹œì‘! ${players[0].config.name}ì˜ ì°¨ë¡€ (${players[0].config.flip.toUpperCase()}í‚¤)`;
            updateUI();
        }

        function createPlayerUI() {
            const board = document.getElementById('game-board');
            // ë²¨(bell-area)ì€ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ í”Œë ˆì´ì–´ ì˜ì—­ ì‚­ì œ
            const bell = board.querySelector('.bell-area');
            board.innerHTML = '';
            board.appendChild(bell);

            players.forEach(p => {
                const pDiv = document.createElement('div');
                pDiv.className = 'player-area';
                pDiv.innerHTML = `
                    <h2>${p.config.name}</h2>
                    <div class="card-slot">
                        <div id="p${p.id}-deck-visual" class="card back"></div>
                    </div>
                    <div>ë‚¨ì€ ì¹´ë“œ: <span id="p${p.id}-count">0</span></div>
                    <div class="card-slot" id="p${p.id}-open-slot"></div>
                    <div class="controls">
                        ë’¤ì§‘ê¸°: <strong>${p.config.flip.toUpperCase()}</strong> / ì¢…: <strong>${p.config.bell.toUpperCase()}</strong>
                    </div>
                `;
                board.appendChild(pDiv);
            });
        }

        function updateUI() {
            players.forEach(p => {
                document.getElementById(`p${p.id}-count`).innerText = p.deck.length;
                const deckVisual = document.getElementById(`p${p.id}-deck-visual`);
                if(deckVisual) deckVisual.style.display = p.deck.length > 0 ? 'flex' : 'none';
                
                renderOpenCard(`p${p.id}-open-slot`, p.openCard);
            });
        }

        function renderOpenCard(slotId, card) {
            const slot = document.getElementById(slotId);
            slot.innerHTML = '';
            if (card) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                
                // ê³¼ì¼ ê°œìˆ˜ë§Œí¼ ì•„ì´ì½˜ ë°˜ë³µ í‘œì‹œ
                let content = `<div class="card-content">`;
                for(let i=0; i<card.count; i++) {
                    content += `<div class="fruit-icon">${card.fruit}</div>`;
                }
                content += `</div>`;
                
                cardDiv.innerHTML = content;
                slot.appendChild(cardDiv);
            }
        }

        function flipCard(playerIndex) {
            if (!gameActive) return;
            
            // í˜„ì¬ í„´ì¸ í”Œë ˆì´ì–´ì¸ì§€ í™•ì¸
            if (turn !== playerIndex) {
                return;
            }

            const player = players[playerIndex];

            if (player.deck.length === 0) {
                // ì¹´ë“œê°€ ì—†ìœ¼ë©´ íƒˆë½ ì²˜ë¦¬í•´ì•¼ í•˜ì§€ë§Œ, ê°„ë‹¨íˆ íŒ¨ë°° ì²˜ë¦¬
                endGame(playerIndex === 0 ? 2 : 1); // ì„ì‹œ ë¡œì§
                return; 
            }

            player.openCard = player.deck.pop();
            
            // ë‹¤ìŒ í„´ ê³„ì‚°
            let nextTurn = (turn + 1) % players.length;
            
            turn = nextTurn;
            const nextPlayer = players[turn];
            document.getElementById('status-msg').innerText = `${nextPlayer.config.name}ì˜ ì°¨ë¡€ (${nextPlayer.config.flip.toUpperCase()}í‚¤)`;
            
            updateUI();
        }

        function ringBell(playerIndex) {
            if (!gameActive) return;
            const player = players[playerIndex];

            // ì¢… ì• ë‹ˆë©”ì´ì…˜
            const bell = document.getElementById('bell');
            bell.classList.add('bell-ring');
            setTimeout(() => bell.classList.remove('bell-ring'), 200);

            // íŒì • ë¡œì§
            let totalFruits = {};
            players.forEach(p => {
                if(p.openCard) {
                    totalFruits[p.openCard.fruit] = (totalFruits[p.openCard.fruit] || 0) + p.openCard.count;
                }
            });

            // ì •í™•íˆ 5ê°œì¸ ê³¼ì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            const isHalliGalli = Object.values(totalFruits).includes(5);

            if (isHalliGalli) {
                document.getElementById('status-msg').innerText = `ğŸ”” í• ë¦¬ê°ˆë¦¬! ${player.config.name} ìŠ¹ë¦¬!`;
                
                // ë°”ë‹¥ì— ê¹”ë¦° ëª¨ë“  ì¹´ë“œ ìˆ˜ê±°
                const gatheredCards = [];
                players.forEach(p => {
                    if(p.openCard) {
                        gatheredCards.push(p.openCard);
                        p.openCard = null;
                    }
                });
                
                // ìŠ¹ì ë±ì— ì¶”ê°€
                player.deck.unshift(...gatheredCards);
                
                // ì´ê¸´ ì‚¬ëŒì´ ì„ 
                turn = playerIndex;
                document.getElementById('status-msg').innerText += ` ${player.config.name}ë¶€í„° ë‹¤ì‹œ ì‹œì‘!`;
            } else {
                document.getElementById('status-msg').innerText = `âŒ ì‹¤ìˆ˜! ${player.config.name}ê°€ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ì¹´ë“œë¥¼ ì¤ë‹ˆë‹¤.`;
                
                // ë²Œì¹™: ë‹¤ë¥¸ ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ë‚´ ì¹´ë“œ 1ì¥ì”© ì£¼ê¸°
                if(player.deck.length >= (players.length - 1)) {
                    players.forEach((p, idx) => {
                        if(idx !== playerIndex) {
                            p.deck.unshift(player.deck.pop());
                        }
                    });
                }
            }
            updateUI();
            
            // ì¢…ë£Œ ì¡°ê±´ ì²´í¬
            const survivors = players.filter(p => p.deck.length > 0 || p.openCard);
            if (survivors.length === 1) {
                endGame(survivors[0].config.name);
            }
        }

        function endGame(winner) {
            gameActive = false;
            document.getElementById('status-msg').innerText = `ğŸ‰ ê²Œì„ ì¢…ë£Œ! ${winner} ìµœì¢… ìŠ¹ë¦¬! ğŸ‰`;
            alert(`${winner} ìµœì¢… ìŠ¹ë¦¬!`);
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('keydown', (e) => {
            if(!gameActive) return;
            const key = e.key.toLowerCase();
            
            players.forEach((p, idx) => {
                if(key === p.config.flip) flipCard(idx);
                if(key === p.config.bell) ringBell(idx);
            });
        });

        // ì´ˆê¸°í™”ë©´ ëŒ€ê¸° (initGameì€ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
    </script>
</body>
</html>
